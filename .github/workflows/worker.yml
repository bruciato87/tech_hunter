name: Tech Sniper IT Worker

on:
  workflow_dispatch:
    inputs:
      products_json:
        description: "JSON array of Amazon products ({title,price_eur,category,ean,url})"
        required: false
        default: "[]"
        type: string
  repository_dispatch:
    types: [scan, telegram_command]
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: tech-sniper-it-worker
  cancel-in-progress: false

jobs:
  run-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_TABLE: ${{ secrets.SUPABASE_TABLE }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
      OPENROUTER_API_KEYS: ${{ secrets.OPENROUTER_API_KEYS }}
      OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
      OPENROUTER_BASE_URL: ${{ secrets.OPENROUTER_BASE_URL }}
      MIN_SPREAD_EUR: ${{ secrets.MIN_SPREAD_EUR }}
      MAX_PARALLEL_PRODUCTS: ${{ secrets.MAX_PARALLEL_PRODUCTS }}
      PLAYWRIGHT_NAV_TIMEOUT_MS: ${{ secrets.PLAYWRIGHT_NAV_TIMEOUT_MS }}
      HEADLESS: "true"
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Inject workflow_dispatch products
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          printf "AMAZON_PRODUCTS_JSON=%s\n" '${{ github.event.inputs.products_json }}' >> "$GITHUB_ENV"

      - name: Validate environment
        run: |
          python scripts/validate_env.py

      - name: Run multi-site arbitrage worker
        run: |
          python -u -m tech_sniper_it.worker
