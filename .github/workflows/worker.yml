name: Tech Sniper IT Worker

on:
  workflow_dispatch:
    inputs:
      products_json:
        description: "JSON array of Amazon products ({title,price_eur,category,ean,url})"
        required: false
        default: "[]"
        type: string
  repository_dispatch:
    types: [scan, telegram_command]
  schedule:
    - cron: "0 * * * *"

concurrency:
  group: tech-sniper-it-worker
  cancel-in-progress: false

jobs:
  run-scan:
    runs-on: ${{ fromJson(vars.ACTIONS_RUNS_ON_JSON || '["ubuntu-latest"]') }}
    timeout-minutes: 50
    env:
      SUPABASE_URL: ${{ vars.SUPABASE_URL || secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_TABLE: ${{ vars.SUPABASE_TABLE || 'arbitrage_opportunities' }}
      SUPABASE_WRITE_MAX_ATTEMPTS: ${{ vars.SUPABASE_WRITE_MAX_ATTEMPTS || '3' }}
      SUPABASE_WRITE_RETRY_DELAY_MS: ${{ vars.SUPABASE_WRITE_RETRY_DELAY_MS || '250' }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID || secrets.TELEGRAM_CHAT_ID }}
      OPENROUTER_API_KEYS: ${{ secrets.OPENROUTER_API_KEYS }}
      OPENROUTER_MODEL: ${{ vars.OPENROUTER_MODEL || 'openrouter/auto' }}
      OPENROUTER_BASE_URL: ${{ vars.OPENROUTER_BASE_URL || 'https://openrouter.ai/api/v1/chat/completions' }}
      OPENROUTER_FREE_MODELS: ${{ vars.OPENROUTER_FREE_MODELS || 'perplexity/sonar,deepseek/deepseek-r1:free,qwen/qwen-2.5-72b-instruct:free,meta-llama/llama-3.3-70b-instruct:free,mistralai/mistral-small-3.1-24b-instruct:free,google/gemini-2.0-flash-exp:free' }}
      OPENROUTER_MODEL_POWER_JSON: ${{ vars.OPENROUTER_MODEL_POWER_JSON || '{"perplexity/sonar":300,"deepseek/deepseek-r1:free":220,"qwen/qwen-2.5-72b-instruct:free":180,"meta-llama/llama-3.3-70b-instruct:free":170,"mistralai/mistral-small-3.1-24b-instruct:free":160,"google/gemini-2.0-flash-exp:free":150}' }}
      OPENROUTER_MAX_MODELS_PER_REQUEST: ${{ vars.OPENROUTER_MAX_MODELS_PER_REQUEST || '2' }}
      OPENROUTER_MODEL_COOLDOWN_SECONDS: ${{ vars.OPENROUTER_MODEL_COOLDOWN_SECONDS || '900' }}
      OPENROUTER_MODEL_NOT_FOUND_COOLDOWN_SECONDS: ${{ vars.OPENROUTER_MODEL_NOT_FOUND_COOLDOWN_SECONDS || '86400' }}
      OPENROUTER_MODEL_TRANSIENT_COOLDOWN_SECONDS: ${{ vars.OPENROUTER_MODEL_TRANSIENT_COOLDOWN_SECONDS || '120' }}
      MIN_SPREAD_EUR: ${{ vars.MIN_SPREAD_EUR || '40' }}
      STRATEGY_PROFILE: ${{ vars.STRATEGY_PROFILE || 'balanced' }}
      MAX_PARALLEL_PRODUCTS: ${{ vars.MAX_PARALLEL_PRODUCTS || '3' }}
      SCAN_TELEGRAM_INDIVIDUAL_ALERTS: ${{ vars.SCAN_TELEGRAM_INDIVIDUAL_ALERTS || 'false' }}
      SCAN_TARGET_PRODUCTS: ${{ vars.SCAN_TARGET_PRODUCTS || '16' }}
      SCAN_CANDIDATE_MULTIPLIER: ${{ vars.SCAN_CANDIDATE_MULTIPLIER || '4' }}
      SCAN_DYNAMIC_QUERIES_ENABLED: ${{ vars.SCAN_DYNAMIC_QUERIES_ENABLED || 'true' }}
      SCAN_DYNAMIC_QUERY_LIMIT: ${{ vars.SCAN_DYNAMIC_QUERY_LIMIT || '16' }}
      SCAN_TARGET_PRODUCTS_AUTO_BOOST: ${{ vars.SCAN_TARGET_PRODUCTS_AUTO_BOOST || 'true' }}
      SCAN_TARGET_PRODUCTS_MAX: ${{ vars.SCAN_TARGET_PRODUCTS_MAX || '20' }}
      SCAN_TARGET_PRODUCTS_BOOST_TRIGGER_MULTIPLIER: ${{ vars.SCAN_TARGET_PRODUCTS_BOOST_TRIGGER_MULTIPLIER || '2.5' }}
      SCAN_TARGET_PRODUCTS_BOOST_STEP: ${{ vars.SCAN_TARGET_PRODUCTS_BOOST_STEP || '4' }}
      SCAN_DYNAMIC_EXPLORATION_RATIO: ${{ vars.SCAN_DYNAMIC_EXPLORATION_RATIO || '0.35' }}
      SCAN_DYNAMIC_TREND_MIN_SCORE: ${{ vars.SCAN_DYNAMIC_TREND_MIN_SCORE || '-35' }}
      SCAN_REQUIRE_COMPLETE_RESELLER_QUOTES: ${{ vars.SCAN_REQUIRE_COMPLETE_RESELLER_QUOTES || 'false' }}
      SCAN_RESELLER_REFILL_BATCH_MULTIPLIER: ${{ vars.SCAN_RESELLER_REFILL_BATCH_MULTIPLIER || '2' }}
      EXCLUDE_MIN_KEEP: ${{ vars.EXCLUDE_MIN_KEEP || '4' }}
      NON_PROFITABLE_SAVE_MAX_PARALLEL: ${{ vars.NON_PROFITABLE_SAVE_MAX_PARALLEL || '3' }}
      SCAN_IT_QUOTA: ${{ vars.SCAN_IT_QUOTA || '6' }}
      SCAN_EU_QUOTA: ${{ vars.SCAN_EU_QUOTA || '6' }}
      SCORING_ENABLE: ${{ vars.SCORING_ENABLE || 'true' }}
      SCORING_LOOKBACK_DAYS: ${{ vars.SCORING_LOOKBACK_DAYS || '30' }}
      SCORING_HISTORY_LIMIT: ${{ vars.SCORING_HISTORY_LIMIT || '2000' }}
      SCAN_FILTER_ACCESSORIES: ${{ vars.SCAN_FILTER_ACCESSORIES || 'true' }}
      PLAYWRIGHT_NAV_TIMEOUT_MS: ${{ vars.PLAYWRIGHT_NAV_TIMEOUT_MS || '45000' }}
      REBUY_USE_STORAGE_STATE: ${{ vars.REBUY_USE_STORAGE_STATE || 'true' }}
      REBUY_STORAGE_STATE_B64: ${{ secrets.REBUY_STORAGE_STATE_B64 }}
      MPB_MAX_ATTEMPTS: ${{ vars.MPB_MAX_ATTEMPTS || '3' }}
      MPB_USE_STORAGE_STATE: ${{ vars.MPB_USE_STORAGE_STATE || 'true' }}
      MPB_STORAGE_STATE_B64: ${{ secrets.MPB_STORAGE_STATE_B64 }}
      MPB_BLOCK_COOLDOWN_SECONDS: ${{ vars.MPB_BLOCK_COOLDOWN_SECONDS || '1800' }}
      MPB_REQUIRE_STORAGE_STATE: ${{ vars.MPB_REQUIRE_STORAGE_STATE || 'true' }}
      VALUATOR_MAX_PARALLEL_MPB: ${{ vars.VALUATOR_MAX_PARALLEL_MPB || '1' }}
      VALUATOR_MAX_PARALLEL_TRENDDEVICE: ${{ vars.VALUATOR_MAX_PARALLEL_TRENDDEVICE || '2' }}
      TRENDDEVICE_LEAD_EMAIL: ${{ vars.TRENDDEVICE_LEAD_EMAIL || secrets.TRENDDEVICE_LEAD_EMAIL }}
      TRENDDEVICE_USE_STORAGE_STATE: ${{ vars.TRENDDEVICE_USE_STORAGE_STATE || 'true' }}
      TRENDDEVICE_STORAGE_STATE_B64: ${{ secrets.TRENDDEVICE_STORAGE_STATE_B64 }}
      AMAZON_WAREHOUSE_ENABLED: ${{ vars.AMAZON_WAREHOUSE_ENABLED || 'true' }}
      AMAZON_WAREHOUSE_MARKETPLACES: ${{ vars.AMAZON_WAREHOUSE_MARKETPLACES || 'it,eu' }}
      AMAZON_WAREHOUSE_MAX_PRODUCTS: ${{ vars.AMAZON_WAREHOUSE_MAX_PRODUCTS || '12' }}
      AMAZON_WAREHOUSE_MAX_PRICE_EUR: ${{ vars.AMAZON_WAREHOUSE_MAX_PRICE_EUR }}
      AMAZON_WAREHOUSE_QUERIES: ${{ vars.AMAZON_WAREHOUSE_QUERIES }}
      AMAZON_WAREHOUSE_PER_MARKETPLACE_LIMIT: ${{ vars.AMAZON_WAREHOUSE_PER_MARKETPLACE_LIMIT || '4' }}
      AMAZON_WAREHOUSE_ROTATE_PROXY: ${{ vars.AMAZON_WAREHOUSE_ROTATE_PROXY || 'true' }}
      AMAZON_WAREHOUSE_ROTATE_USER_AGENT: ${{ vars.AMAZON_WAREHOUSE_ROTATE_USER_AGENT || 'true' }}
      AMAZON_WAREHOUSE_USER_AGENTS: ${{ vars.AMAZON_WAREHOUSE_USER_AGENTS }}
      AMAZON_WAREHOUSE_MAX_ATTEMPTS_PER_QUERY: ${{ vars.AMAZON_WAREHOUSE_MAX_ATTEMPTS_PER_QUERY || '3' }}
      AMAZON_WAREHOUSE_RETRY_DELAY_MS: ${{ vars.AMAZON_WAREHOUSE_RETRY_DELAY_MS || '700' }}
      AMAZON_WAREHOUSE_FAIL_FAST_ON_SORRY: ${{ vars.AMAZON_WAREHOUSE_FAIL_FAST_ON_SORRY || 'true' }}
      AMAZON_WAREHOUSE_STEALTH: ${{ vars.AMAZON_WAREHOUSE_STEALTH || 'true' }}
      AMAZON_WAREHOUSE_USE_STORAGE_STATE: ${{ vars.AMAZON_WAREHOUSE_USE_STORAGE_STATE || 'true' }}
      AMAZON_WAREHOUSE_STORAGE_STATE_B64: ${{ secrets.AMAZON_WAREHOUSE_STORAGE_STATE_B64 }}
      AMAZON_WAREHOUSE_STORAGE_STATE_B64_IT: ${{ secrets.AMAZON_WAREHOUSE_STORAGE_STATE_B64_IT }}
      AMAZON_WAREHOUSE_STORAGE_STATE_B64_DE: ${{ secrets.AMAZON_WAREHOUSE_STORAGE_STATE_B64_DE }}
      AMAZON_WAREHOUSE_STORAGE_STATE_B64_FR: ${{ secrets.AMAZON_WAREHOUSE_STORAGE_STATE_B64_FR }}
      AMAZON_WAREHOUSE_STORAGE_STATE_B64_ES: ${{ secrets.AMAZON_WAREHOUSE_STORAGE_STATE_B64_ES }}
      AMAZON_WAREHOUSE_CART_PRICING_ENABLED: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_ENABLED || secrets.AMAZON_WAREHOUSE_CART_PRICING_ENABLED || 'false' }}
      AMAZON_WAREHOUSE_CART_PRICING_MAX_ITEMS: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_MAX_ITEMS || secrets.AMAZON_WAREHOUSE_CART_PRICING_MAX_ITEMS || '4' }}
      AMAZON_WAREHOUSE_CART_PRICING_REQUIRE_EMPTY_CART: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_REQUIRE_EMPTY_CART || secrets.AMAZON_WAREHOUSE_CART_PRICING_REQUIRE_EMPTY_CART || 'true' }}
      AMAZON_WAREHOUSE_CART_PRICING_ALLOW_DELTA: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_ALLOW_DELTA || secrets.AMAZON_WAREHOUSE_CART_PRICING_ALLOW_DELTA || 'true' }}
      AMAZON_WAREHOUSE_CART_PRICING_DIRECT_ADD_FALLBACK: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_DIRECT_ADD_FALLBACK || 'true' }}
      AMAZON_WAREHOUSE_CART_PRICING_FORCE_EMPTY_AFTER_HOST: ${{ vars.AMAZON_WAREHOUSE_CART_PRICING_FORCE_EMPTY_AFTER_HOST || 'true' }}
      AMAZON_WAREHOUSE_DEBUG_ON_EMPTY: ${{ vars.AMAZON_WAREHOUSE_DEBUG_ON_EMPTY || 'true' }}
      AMAZON_WAREHOUSE_DEBUG_DIR: ${{ vars.AMAZON_WAREHOUSE_DEBUG_DIR || '/tmp/tech_sniper_it_debug' }}
      AMAZON_WAREHOUSE_PROXY_URLS: ${{ secrets.AMAZON_WAREHOUSE_PROXY_URLS }}
      HEADLESS: "true"
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Inject workflow_dispatch products
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          printf "AMAZON_PRODUCTS_JSON=%s\n" '${{ github.event.inputs.products_json }}' >> "$GITHUB_ENV"

      - name: Validate environment
        run: |
          python scripts/validate_env.py

      - name: Run multi-site arbitrage worker
        run: |
          python -u -m tech_sniper_it.worker
